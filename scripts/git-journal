#!/usr/bin/env python3

import os
import sys
import subprocess


ALIAS = {
    'read': ['log'],
    'pages': ['log', '--date=short', '--format=%C(red)%h%Creset %C(green)%ad%Creset %s'],
    'write': ['commit', '--allow-empty'],
    'save': ['push'],
}


def usage():
    text = [
        f'Usage: {os.path.basename(__file__)} <command>',
        f'{os.path.basename(__file__)} is a script meant to interact with a'
        ' git repository used as a journal.',
        'Any git command is a valid subcommand.',
        'Aliases added by this script:',
    ]
    for alias, command in ALIAS.items():
        text.append(f'  {alias:<6}: {" ".join(command)}')
    print('\n'.join(text))
    return 0


def git_command(command: list):
    workdir = os.environ['JOURNAL_REPO']
    gitdir = os.path.join(workdir, '.git')
    git = ['git',  '--git-dir', gitdir, '--work-tree', workdir]
    return subprocess.call(git + command)


def main(argv):
    args = argv[1:]
    if argv[1] in ALIAS:
        args = ALIAS[argv[1]] + argv[2:]
    return git_command(args)


if __name__ == "__main__":
    if len(sys.argv) < 2 or sys.argv[1] == 'help':
        sys.exit(usage())
    try:
        sys.exit(main(sys.argv))
    except KeyError:
        sys.exit(
            "Set the environment variable 'JOURNAL_REPO' to a path pointing "
            "to a git repository which will be used as a journal."
        )
